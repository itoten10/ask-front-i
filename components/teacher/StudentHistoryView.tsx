// ask-front-i/components/teacher/StudentHistoryView.tsx

"use client";

import { Button } from "@/components/ui/button";
import { ArrowLeft, ArrowUp } from "lucide-react"; // ★ArrowUp追加
import { StandardPostCard, Post } from "@/components/student/StudentPostCards";
import { FeatureInfoModal } from "@/components/student/FeatureInfoModal";
import { PostDetailModal } from "@/components/student/PostDetailModal";
import { useState, useMemo, useRef } from "react"; // ★useRef追加

interface StudentHistoryViewProps {
  studentName: string;
  onBack: () => void;
}

export function StudentHistoryView({ studentName, onBack }: StudentHistoryViewProps) {
  const [showCommentInfo, setShowCommentInfo] = useState(false);
  const [selectedPost, setSelectedPost] = useState<Post | null>(null);

  // ★追加: スクロールトップボタンの状態管理
  const [showScrollTop, setShowScrollTop] = useState(false);
  const scrollContainerRef = useRef<HTMLDivElement>(null);

  // ダミーデータ生成ロジック
  const posts = useMemo(() => {
    // 生徒ごとのプロファイル設定
    const profiles: Record<string, { theme: string; lab: string; avatar: string; contents: string[] }> = {
      "髙橋 由華": {
        theme: "ストレスと運動の科学的関係",
        lab: "メディアラボ",
        avatar: "/avatars/01.jpg",
        contents: [
          "アンケート結果の集計が終わりました。予想以上に「運動で気分が晴れる」と答えた人が多かったです。今後は年齢や性別ごとの傾向も分析してみたいと思います。さらに、運動の頻度や種類による違いも詳しく調べてみる予定です。",
          "今日は文献調査。セロトニンの分泌メカニズムについて論文を読みました。専門用語が難しくて苦戦中ですが、図解を使って理解を深めています。今後は脳内物質とストレスの関係についても掘り下げていきたいです。",
          "インタビューの準備をしています。運動部の顧問の先生に話を聞く予定です。質問内容を整理し、録音の許可も事前にお願いしました。実際の現場の声を聞くことで、仮説の裏付けや新たな視点が得られることを期待しています。",
          "仮説「短時間の有酸素運動でもストレス軽減効果がある」を検証するための実験計画を立てました。必要な機材や協力者のリストも作成しました。実験の手順や測定項目も細かく決めて、信頼性の高いデータを集めたいです。",
          "グラフの作成中。Canvaを使って見やすくまとめる工夫をしています。色使いやフォントにもこだわり、発表資料としても使えるようにしています。データの傾向が一目で分かるように、注釈や凡例も丁寧に入れました。",
          "実験協力者を集めています。今のところ5人。あと5人は欲しいので、クラスメイトや友人にも声をかけてみる予定です。協力のお礼も考え中。できるだけ多様な属性の人に参加してもらい、幅広いデータを集めたいです。",
          "先行研究と自分の仮説のズレが見つかりました。修正が必要です。特に運動の頻度による影響について、再度文献を調べ直すことにしました。自分の考えに固執せず、柔軟に仮説を見直す姿勢を大切にしたいです。",
          "運動の種類による違いについても考慮する必要がありそうです。有酸素運動と筋トレで効果が異なるか、追加で調査を進めます。今後はヨガやストレッチなど、他の運動も対象に含めて比較してみたいと思います。",
          "今日は一日中図書館にこもって資料探し。良い本が見つかりました。特にストレスホルモンに関する章が参考になりそうです。専門書だけでなく、一般向けの書籍も読むことで、幅広い知識を身につけたいです。",
          "中間発表の資料作成。伝えたいことが多すぎてスライドが文字だらけに…。要点を絞って、図や写真を多めに入れる工夫をしています。発表練習も重ねて、聞き手に分かりやすく伝えることを意識しています。",
          "先生からフィードバックをもらいました。「問いをもっと具体的に」とのこと。自分の興味を深掘りし、問い直しを行う予定です。今後は、より明確な目的意識を持って研究を進めていきたいと考えています。",
          "リラックス効果の測定方法について、心拍数以外の指標がないか探しています。アンケートや唾液中の成分測定も候補に挙がっています。複数の方法を組み合わせて、より客観的なデータを得ることを目指します。",
          "友人の悩み相談に乗っていたら、今回のテーマのヒントをもらいました。身近な体験から新しい視点が得られることを実感しました。今後も周囲の人の意見や経験を積極的に取り入れていきたいです。",
          "運動習慣がない人へのアプローチも考えたいです。初心者でも取り組みやすい運動メニューを提案できるようにしたいと思います。運動のハードルを下げる工夫や、継続のコツも調べてまとめていきます。",
          "実験データの整理。エクセル関数を駆使してなんとか完了。グラフ化することで傾向が見えやすくなり、考察の材料が増えました。今後はデータの可視化にも力を入れていきたいです。",
          "考察が浅い気がする。もう一度データを読み直してみます。異なる視点から分析し直し、新たな発見がないか探してみたいです。先生や友人にも意見をもらい、より深い考察を目指します。",
          "ポスターのデザイン案を作成。色は青系で落ち着いた感じに。見やすさとインパクトの両立を目指して、レイアウトにも工夫を凝らしました。発表会で多くの人に興味を持ってもらえるようにしたいです。",
          "発表練習をしました。時間をオーバーしてしまったので内容を削ります。要点をまとめて、聞き手に伝わりやすい構成に修正しました。緊張しないように何度も練習を重ねています。",
          "いよいよ明日が本番。緊張するけど頑張ります。これまでの努力を信じて、落ち着いて発表できるようにイメージトレーニングもしました。自分の言葉でしっかり伝えたいです。",
          "振り返り。計画通りに進まないこともあったけど、多くの学びがありました。今後の課題も見つかったので、次に活かしたいです。今回の経験を通じて、探究の面白さを改めて実感しました。"
        ]
      },
      "江藤 泰平": {
        theme: "クラスの心理的安全性とリーダーシップ",
        lab: "メディアラボ",
        avatar: "/avatars/02.jpg",
        contents: [
          "チームでの議論が白熱しました。意見が対立したときにどうまとめるか、ファシリテーションの難しさを痛感。全員の意見を尊重しつつ、最終的な方向性を決めるためにリーダーとしての役割を強く意識しました。",
          "「心理的安全性」についての本を読んでいます。Googleの事例が参考になります。実際の現場でどのように安全な雰囲気を作っているのか、具体的な施策や失敗談も知ることができてとても勉強になりました。",
          "今日はみんなの意見を聞くことに徹しました。聞き役に回ることで見えてくるものがあります。普段は発言しないメンバーの考えや、グループの雰囲気の変化にも気づくことができて新鮮な体験でした。",
          "プロジェクトの進捗管理表を作成。Notionを使ってみんなで共有できるようにしました。タスクの可視化や期日の設定など、全員が自分の役割を把握しやすくなり、作業効率が上がったと感じています。",
          "メンバーから「話しやすかった」と言ってもらえて嬉しかったです。この雰囲気を維持したい。今後も積極的に声かけをして、誰もが安心して意見を言える場作りを心がけていきたいと思います。",
          "リーダーとしての振る舞いについて自己省察。もっと任せる勇気が必要かも。自分が抱え込みすぎず、メンバーに信頼して仕事を任せることで、チーム全体の成長につながると実感しました。",
          "ブレインストーミングを実施。質より量を意識してアイデア出し。自由な発想を大切にし、否定せずにどんどん意見を出し合うことで、思いがけないアイデアが生まれて盛り上がりました。",
          "反対意見が出たときの対応について、先生にアドバイスをもらいました。感情的にならず、相手の立場に立って考えることの大切さを学びました。今後は冷静に対話できるよう意識したいです。",
          "会議の時間を短縮するためのルール作り。タイムキーパーを置くことに。議題ごとに時間を区切ることで、ダラダラせずに効率よく話し合いが進むようになり、全員の集中力も高まりました。",
          "モチベーションが下がっているメンバーへの声かけ。どう言えば伝わるか悩む。相手の気持ちに寄り添いながら、無理せず自分のペースで進めていいと伝えることで少し元気になってくれました。",
          "他チームのリーダーと情報交換。みんな同じような悩みを持っているんだな。成功例や失敗談を共有し合うことで、自分の課題も客観的に見つめ直すことができ、今後の参考になりました。",
          "心理的安全性を測るアンケートを作成中。質問項目を推敲。メンバーが本音で答えやすいように、言葉遣いや選択肢にも工夫を凝らし、匿名性を高めて率直な意見を集めることを目指しています。",
          "失敗を許容する空気作り。まずは自分が失敗談を話してみた。自分の弱みをさらけ出すことで、他のメンバーも安心してチャレンジできる雰囲気が生まれ、チームの一体感が高まりました。",
          "アイスブレイクのネタ探し。場が和むようなゲームはないかな。ネットや本で調べて、短時間でできる簡単なワークをいくつか試してみたところ、みんなの表情が柔らかくなって良い雰囲気になりました。",
          "振り返り会（KPT）を実施。Next Actionが具体的になりました。良かった点だけでなく、改善点や今後の目標も全員で共有することで、次の活動へのモチベーションが高まりました。",
          "役割分担の見直し。得意なことを活かせる配置に。メンバーそれぞれの強みや希望を聞きながら、最適な役割を決め直したことで、作業効率と満足度が大きく向上しました。",
          "中間報告の準備。チームの成長プロセスを可視化したい。活動の記録やメンバーの変化をグラフや写真でまとめ、発表資料として分かりやすく整理することを心がけています。",
          "資料のデザインを統一。視認性を高める工夫。フォントや配色、レイアウトを揃えることで、誰が見ても分かりやすい資料になり、発表の説得力も増したと感じています。",
          "発表のリハーサル。声のトーンや大きさに気をつけて。緊張しないように何度も練習し、メンバー同士でフィードバックし合うことで、より良い発表を目指して仕上げました。",
          "プロジェクト終了。チームのみんなに感謝の手紙を書きました。これまでの苦労や成長を振り返りながら、一人ひとりにメッセージを送り、最後はみんなで記念写真を撮って締めくくりました。"
        ]
      },
      "由井 理月": {
        theme: "地域情報のデジタルアーカイブ化",
        lab: "メディアラボ",
        avatar: "/avatars/04.jpg",
        contents: [
          "図書館で古い地図を発見。現在の街並みと比較すると面白い変化が見えてきました。地元の歴史を知る手がかりとして、今後はさらに古い資料も探してみたいと思います。",
          "情報の整理手法について調査中。メタデータの付け方が重要だと分かりました。分類やタグ付けのルールを決めることで、後から検索しやすくなるよう工夫しています。",
          "現地調査に行ってきました。古くからあるお店の方に話を聞くことができました。昔の写真やエピソードも聞けて、地域の魅力を再発見する良い機会になりました。",
          "集めたデータをエクセルに入力中。単純作業だけど、ここが一番大事な気がする。正確に入力することで、後の分析や公開作業がスムーズに進むよう心がけています。",
          "アーカイブの公開方法について検討。Webサイトにするか、アプリにするか迷っています。利用者の年齢層や使いやすさも考慮して、最適な方法を選びたいです。",
          "著作権について調べる必要があります。古い写真の使用許可はどうなるんだろう。専門家にも相談しながら、安心して公開できるように準備を進めています。",
          "街の古老にインタビュー。教科書には載っていない生の話が聞けました。昔の暮らしや地域の伝統行事について、貴重な証言をたくさん記録できました。",
          "音声データの文字起こし。方言が難しくて時間がかかります。聞き取りにくい部分は家族にも協力してもらい、できるだけ正確に記録するよう努力しています。",
          "データのバックアップを作成。消えたら泣くので念入りに。外付けHDDやクラウドにも保存し、万が一のトラブルにも備えています。",
          "タグ付けのルールを策定。検索しやすくするための工夫。利用者が直感的に情報を探せるよう、カテゴリやキーワードを細かく設定しました。",
          "似たような取り組みをしている他県の事例をリサーチ。成功例や課題点を参考にしながら、自分たちのアーカイブにも活かせるアイデアをまとめています。",
          "サイトのプロトタイプを作成。UIは見やすさを重視。実際に家族や友人に使ってもらい、使い勝手やデザインについてフィードバックをもらいました。",
          "写真のデジタル化作業。スキャナーの調子が悪い...。何度もやり直しながら、画質や保存形式にもこだわって作業を進めています。",
          "分類カテゴリの見直し。「歴史」「文化」「生活」で分けることに。利用者の視点に立って、より分かりやすい構成を目指して再編成しました。",
          "先生に進捗報告。データの質の高さを褒められました。今後は量だけでなく、内容の充実にも力を入れていきたいと考えています。",
          "公開範囲の検討。プライバシーへの配慮が必要。個人情報やセンシティブな内容は慎重に扱い、関係者の同意も得るようにしています。",
          "利用規約の作成。難しい言葉が多くて頭が痛い。専門用語を分かりやすく言い換えたり、例を挙げて説明したりと工夫しています。",
          "テスト公開に向けてバグチェック。実際に操作してみて、表示崩れやリンク切れがないか細かく確認しています。",
          "プレゼン資料の作成。このアーカイブの意義を熱く伝えたい。地域の人たちにも分かりやすく、興味を持ってもらえるように工夫しています。",
          "ようやく完成！地域の方々にも使ってもらいたいです。今後は利用者の声を聞きながら、さらに内容を充実させていきたいと思います。"
        ]
      },
      "伊藤 誠人": {
        theme: "廃棄野菜を活用した新商品開発",
        lab: "メディアラボ",
        avatar: "/avatars/03.jpg",
        contents: [
          "試作品第1号が完成！味は...正直微妙でした。スパイスの配合を見直す必要がありそう。見た目や食感も改良の余地があるので、次回はもっと工夫してみたいです。",
          "農家さんのところへ行って、廃棄される野菜の現状を見せてもらいました。なんとか活用したい。生産者の思いや現場の課題も直接聞くことができ、より強い動機づけになりました。",
          "パッケージデザインのラフを描いてみました。手に取りたくなるような見た目を意識しています。色やロゴ、キャッチコピーも工夫して、消費者の目を引くデザインを目指しています。",
          "試食会を実施。辛辣な意見ももらったけど、改善のヒントがたくさん得られました。味だけでなく、食べやすさや価格についても率直なフィードバックをもらい、今後の参考にします。",
          "コスト計算をしてみたら、予想以上に高くなってしまいました。材料の調達ルートを見直します。大量生産時のコストダウン方法や、地元企業との連携も検討しています。",
          "地元のパン屋さんに協力を依頼。生地に練り込むアイデアをもらいました。異業種とのコラボで新しい商品展開ができそうで、今後の展開がますます楽しみになりました。",
          "野菜の乾燥実験。ドライにすれば保存がきくし、用途も広がりそう。乾燥方法による味や栄養価の違いも調べて、最適な加工方法を探っています。",
          "ネーミング案を100個出しました。キャッチーな名前にしたい。みんなで投票したり、ターゲット層に響く言葉をリサーチしたりして、最終候補を絞り込んでいます。",
          "栄養成分の分析について調べています。健康志向の人をターゲットに。専門家にも相談しながら、商品の魅力を科学的にアピールできるよう準備しています。",
          "販売場所の候補をリストアップ。道の駅や学校のイベントなど。実際に現地を見学し、客層や売り場の雰囲気もチェックして、最適な販売戦略を練っています。",
          "保健所の許可について確認。食品を扱うのはハードルが高い...。必要な手続きや衛生管理のポイントを調べ、安心して販売できる体制を整えています。",
          "クラウドファンディングについて調査。資金調達の手段としてありかも。リターンの内容やプロジェクトの魅力的な伝え方についても研究しています。",
          "チームメンバーと味の方向性で対立。でも、良いものを作るための議論。お互いの意見を尊重しながら、納得できるまで話し合いを重ねています。",
          "試作品第2号。今度はかなり美味しい！自信作。前回の反省を活かして改良した結果、見た目も味も大きくレベルアップしました。みんなの反応も上々です。",
          "アンケートを作成してニーズ調査。価格設定の参考にします。ターゲット層の意見を集めて、より多くの人に受け入れられる商品を目指しています。",
          "ロゴマークを作成。親しみやすさを重視。デザイン案を何パターンも作り、チームや家族にも意見をもらいながら、最終的なロゴを決定しました。",
          "宣伝用のチラシ作り。写真の撮り方にもこだわりました。商品の魅力が伝わるように、構図やライティングにも工夫を凝らしています。",
          "プレゼン練習。想いが伝わるように、原稿を読み込まない練習。自分の言葉で熱意を伝えることを意識し、何度もリハーサルを重ねました。",
          "いよいよ発表会。試食も用意してアピールします。来場者の反応を直接聞ける貴重な機会なので、しっかり準備して臨みたいです。",
          "プロジェクトを通して、食への感謝の気持ちが強まりました。廃棄野菜の現状や食の大切さを多くの人に伝えられるよう、今後も活動を続けていきたいです。"
        ]
      }
    };

    const profile = profiles[studentName] || { 
      theme: "探究学習プロジェクト", lab: "所属ゼミ", avatar: "/avatars/05.jpg", contents: ["活動ログを更新しました。"]
    };

    // 20件のデータを生成
    return Array.from({ length: 20 }).map((_, i) => {
      const isNew = i === 0;
      // 生徒ごとのコンテンツリストをループして使用
      const contentText = profile.contents[i % profile.contents.length];
      
      const questionStates = [
        "問いが深まった・変化した",
        "問いの検証が進んだ",
        "周辺の準備作業をした"
      ];

      return {
        id: 2000 + i,
        labName: profile.lab,
        authorName: studentName,
        avatarUrl: profile.avatar, 
        content: `【活動ログ No.${20 - i}】\n${contentText}`,
        isViewedByTeacher: i > 2, 
        isAnonymous: false,
        isMyPost: false,
        likeCount: 5 + (i % 15),
        likedByMe: i % 4 === 0,
        isNew: isNew,
        theme: profile.theme,
        phases: i < 5 ? ["まとめ・表現"] : i < 10 ? ["実験・調査"] : ["情報収集"],
        questionState: i % 4 === 0 ? questionStates[i % 3] : undefined, 
      };
    });
  }, [studentName]);

  const [localPosts, setLocalPosts] = useState<Post[]>(posts);

  const handleLike = (postId: number) => {
    setLocalPosts(prev => prev.map(p => {
      if (p.id === postId) {
        return {
          ...p,
          likedByMe: !p.likedByMe,
          likeCount: p.likedByMe ? p.likeCount - 1 : p.likeCount + 1
        };
      }
      return p;
    }));
  };

  // ★追加: スクロールイベントハンドラ
  const handleScroll = (e: React.UIEvent<HTMLDivElement>) => {
    if (e.currentTarget.scrollTop > 300) {
      setShowScrollTop(true);
    } else {
      setShowScrollTop(false);
    }
  };

  // ★追加: トップへ戻る機能
  const scrollToTop = () => {
    if (scrollContainerRef.current) {
      scrollContainerRef.current.scrollTo({ top: 0, behavior: "smooth" });
    }
  };

  return (
    <div className="flex flex-col h-full space-y-4 animate-in fade-in slide-in-from-right-4 duration-300 relative">
      
      {/* 詳細モーダル */}
      <PostDetailModal 
        post={selectedPost} 
        isOpen={!!selectedPost} 
        onClose={() => setSelectedPost(null)} 
        isLiked={selectedPost ? (localPosts.find(p => p.id === selectedPost.id)?.likedByMe || false) : false}
        onLike={handleLike}
      />

      <FeatureInfoModal
        open={showCommentInfo}
        onClose={() => setShowCommentInfo(false)}
        title="機能のお知らせ"
        description={<>MVP内ではコメント機能は非表示ですが、<br /><strong>投稿数UP</strong>や<strong>生徒同士の情報共有</strong>を<br />促進するためにフェーズ2以降で実装予定です。</>}
      />

      {/* Header */}
      <div className="flex items-center gap-4 pb-4 border-b border-slate-200 shrink-0">
        <Button 
          variant="ghost" 
          size="sm" 
          onClick={onBack}
          className="gap-2 text-slate-500 hover:text-slate-800 hover:bg-slate-100"
        >
          <ArrowLeft className="w-4 h-4" />
          戻る
        </Button>
        <div>
          <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">
            {studentName} <span className="text-sm font-normal text-slate-500">の活動ログ</span>
          </h2>
        </div>
      </div>

      {/* Grid List */}
      <div 
        ref={scrollContainerRef} // ★Refを設定
        onScroll={handleScroll}  // ★イベントを設定
        className="flex-1 overflow-y-auto pr-2 scroll-smooth"
      >
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pb-20">
          {localPosts.map((post) => (
            <StandardPostCard
              key={post.id}
              post={post}
              isLiked={post.likedByMe || false}
              onLike={handleLike}
              onClick={() => setSelectedPost(post)} 
              onComment={() => setShowCommentInfo(true)}
            />
          ))}
        </div>
      </div>

      {/* ★追加: トップへ戻るボタン */}
      <div className={`fixed right-6 bottom-6 z-50 transition-all duration-300 ${showScrollTop ? "opacity-100 translate-y-0" : "opacity-0 translate-y-10 pointer-events-none"}`}>
        <Button 
          onClick={scrollToTop} 
          className="rounded-full w-12 h-12 bg-primary text-white shadow-lg hover:bg-primary/90 hover:scale-110 transition-all" 
          size="icon"
        >
          <ArrowUp className="w-6 h-6" />
        </Button>
      </div>
    </div>
  );
}